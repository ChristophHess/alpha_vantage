language: rust

services: docker

sudo: true

git:
  depth: false

dist: bionic

matrix:
  include:
  - os: linux
    env: CODECOV_COVERAGE=true PUBLISH_PACKAGE=true
    addons:
      apt:
        packages:
          - libcurl4-openssl-dev
          - libelf-dev
          - libdw-dev
          - cmake
          - gcc
          - binutils-dev
          - libiberty-dev
  - os: osx
  - os: windows
  - rust: beta
  - rust: nightly
  - os: windows
    env: TARGET=x86_64-pc-windows-gnu

before_install:
  - chmod -R 777 ci

install:
  - . ci/install.sh

before_script:
  - . ci/before_script.sh

script:
  - . ci/script.sh

deploy:
  - provider: cargo
    token: $CARGO_TOKEN
    on:
      tags: true
      condition: $PUBLISH_PACKAGE = true
  - provider: script
    script: bash ci/codecov_coverage.sh
    skip-cleanup: true
    on:
      all_branches: true
      condition: $CODECOV_COVERAGE = true

notifications:
  email: false